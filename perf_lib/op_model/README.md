## Op model estimate params

Operation parameters in this directory are used to calculate estimated runtime of the ops with specific attributes and dimensions. FE uses this information to perform balancing. Estimated runtime for each op is calculated using a formula with known weights - params from this directory, and variables that represent op dimensions and attributes (number of tiles, ublocks, m_k, u_kt...). To obtain the params, we perform a linear regression on the data generated by perf sweep - op attributes, dimensions and its runtime. More information about how we obtain the params can be found in [perf_lib/op_model/scripts/README.md](../scripts/README.md).

For some ops, we obtain parameters using a single linear regression run on all data, for others, we segment the ops on a specific attribute (eg data format), and perform a regression for different values (eg Bfp vs FP16). Depending on the segmentation, we can have multiple sets of parameters for each op.

#### Versioning

Op model params are versioned to allow PyBuda to decide when to start using new params, instead of picking them up with each Budabackend uplift. Any change in params of one or multiple ops triggers a new version for all ops and params. Versioning is done separately for each architecture.
Version is set in `tt_op_model_descriptor` struct passed from PyBuda requesting estimate for a specific op and its attributes. This means that PyBuda can choose the versions for specific ops which allows them to have a default version used for params, and override it to use older/newer one for specific ops.
Versions are kept in separate files in `perf_lib/op_model/params/<arch_name>` named `params_v{version}.yaml`, and the default one is v1 which represents the latest state of parameters before versioning was introduced. Latest versions per architecture are defined in `OpModel::VERSIONS`.

Currently, versioning is done only for the parameters. Introduction of a new formula would require two-phased upgrade, using either an environment variable or a field in the `tt_op_model_descriptor`. One possibility is to version formulas together with the parameters - whenever either formula or parameters would change, version would be bumped. This would hide all the details of the estimation from PyBuda, but it would work well with some assumptions, eg that we don't expect to use multiple formulas for the same architecture at the same moment. 

In case new op is being added to the param files (not necessarily new op for BBE, but the op that didn't have its own formula and params but used default ones), the op and its params are simply added to the new version - old versions should never be updated retrospectively.

More information on the implementation details can be found in `tt_op_params.cpp`.

### WORMHOLE_B0


The following table shows status of the op model estimation params for B0. 

For each op we add params for, we should add unit tests that calculate estimated runtime for the data used to run the model and compare it with the real execution time. This is useful as it will raise a flag in case we switch params and start getting bigger estimation errors. 

The estimate / reality column shows the interval of the obtained ratio between estimate/reality.

| Op                       | Unit tests added | Estimate / Reality | Note                             |
| ------------------------ |:----------------:|:------------------:| -------------------------------- |
| add                      | +                | 0.8 - 1.1          | estimate/reality ratio refers to bfp params; the same params are used for fp16 estimation (with a specific constant factor) - there is some overestimation so it would be better to obtain separate fp16 params
| subtract                 | +                | 0.8 - 1.1          | estimate/reality ratio refers to bfp params; the same params are used for fp16 estimation (with a specific constant factor) - there is some overestimation so it would be better to obtain separate fp16 params
| multiply                 | +                | 0.8 - 1.1          | estimate/reality ratio refers to bfp params; the same params are used for fp16 estimation (with a specific constant factor) - there is some overestimation so it would be better to obtain separate fp16 params
| nop                      | +                | 0.6 - 1.4          | separate bfp8 and fp16 params
| abs                      |                  |     /              |
| cosine                   |                  |     /              |
| dropout                  |                  |     /              |
| exp                      |                  |     /              |
| exp-approx               | +                | 0.8 - 1.1          |
| gelu                     |                  |     /              |
| gelu-derivative          |                  |     /              |
| gelu-derivative-approx   | +                | 0.8 - 1.1          |
| lrelu                    |                  |     /              |
| log                      |                  |     /              | 
| power                    | +                | 0.6 - 1.3          |
| reciprocal               |                  |     /              |
| reciprocal-approx        | +                | 0.8 - 1.1          |
| sigmoid                  | +                | 0.6 - 1.3          |
| sine                     | +                |     /              |
| sqrt                     |                  |     /              |
| tanh                     |                  |     /              |
| matmul                   |                  |     /              | separate bfp8 and fp16 params
| matmul-l1                |                  |     /              | separate bfp8 and fp16 params
| matmul-sparse (v2)*      | +                | 0.3 - 3.5          | there are a lot of segments; params were obtained by manual measurements on HW, not using the standard linear regression

*Matmul sparse has V1 and V2 formulas. Currently V1 formula is used for both GS and B0, although it has proven to be even 11x off in some cases. V2 formula is an updated version written for B0, and its range goes from 0.3 - 3.5x.


##
Params for the following ops should be regenerated - they either don't exist (default params fallback), have been calculated from the model using very old data, or manually added (without running a model on the perf data).


| Op                | Note                                                                      |
| ----------------- | ------------------------------------------------------------------------- |
| depthwise         | no perf sweep template; manually added params
| reduce-r          | current params don't perform well
| reduce-c          | current params don't perform well
| reduce-z          | current params don't perform well
| splice            | perf sweep template added recently; params should be recalculated
| embedding         | no params
| ethernet_datacopy | no params
| tilizer           | no params
| quantization      | no params
| dequantization    | no params
| requantization    | no params
| topk              | no params
| fused op          | no params; currently, FE doesn't call BBE API for fused op estimation, but has its own approximation

GENERAL NOTE: No estimation parameters were calculated for ops supporting INT8 and INT32 types. They should be added as well.
