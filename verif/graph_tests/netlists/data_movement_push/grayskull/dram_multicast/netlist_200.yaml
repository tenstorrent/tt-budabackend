# test_config_id=8
devices:
  arch: grayskull

queues:
  input0_dram:
    type: queue
    input: HOST
    entries: 1
    grid_size: [5, 3]
    t: 1
    mblock: [48, 20]
    ublock: [1, 1]
    df: Float16
    ublock_order: r
    target_device: 0
    loc: dram
    dram: [[1, 0x10000000], [1, 0x101e7820], [1, 0x103cf040], [1, 0x105b6860], [1, 0x1079e080], [1, 0x109858a0], [1, 0x10b6d0c0], [1, 0x10d548e0], [1, 0x10f3c100], [1, 0x11123920], [1, 0x1130b140], [1, 0x114f2960], [1, 0x116da180], [1, 0x118c19a0], [1, 0x11aa91c0]]

  input1_dram:
    type: queue
    input: HOST
    entries: 1
    grid_size: [10, 12]
    t: 3
    mblock: [2, 1]
    ublock: [3, 1]
    df: Float16
    ublock_order: r
    target_device: 0
    loc: dram
    dram: [[5, 0x10000000], [5, 0x10009260], [5, 0x100124c0], [5, 0x1001b720], [5, 0x10024980], [5, 0x1002dbe0], [5, 0x10036e40], [5, 0x100400a0], [5, 0x10049300], [5, 0x10052560], [5, 0x1005b7c0], [5, 0x10064a20], [5, 0x1006dc80], [5, 0x10076ee0], [5, 0x10080140], [5, 0x100893a0], [5, 0x10092600], [5, 0x1009b860], [5, 0x100a4ac0], [5, 0x100add20], [5, 0x100b6f80], [5, 0x100c01e0], [5, 0x100c9440], [5, 0x100d26a0], [5, 0x100db900], [5, 0x100e4b60], [5, 0x100eddc0], [5, 0x100f7020], [5, 0x10100280], [5, 0x101094e0], [5, 0x10112740], [5, 0x1011b9a0], [5, 0x10124c00], [5, 0x1012de60], [5, 0x101370c0], [5, 0x10140320], [5, 0x10149580], [5, 0x101527e0], [5, 0x1015ba40], [5, 0x10164ca0], [5, 0x1016df00], [5, 0x10177160], [5, 0x101803c0], [5, 0x10189620], [5, 0x10192880], [5, 0x1019bae0], [5, 0x101a4d40], [5, 0x101adfa0], [5, 0x101b7200], [5, 0x101c0460], [5, 0x101c96c0], [5, 0x101d2920], [5, 0x101dbb80], [5, 0x101e4de0], [5, 0x101ee040], [5, 0x101f72a0], [5, 0x10200500], [5, 0x10209760], [5, 0x102129c0], [5, 0x1021bc20], [5, 0x10224e80], [5, 0x1022e0e0], [5, 0x10237340], [5, 0x102405a0], [5, 0x10249800], [5, 0x10252a60], [5, 0x1025bcc0], [5, 0x10264f20], [5, 0x1026e180], [5, 0x102773e0], [5, 0x10280640], [5, 0x102898a0], [5, 0x10292b00], [5, 0x1029bd60], [5, 0x102a4fc0], [5, 0x102ae220], [5, 0x102b7480], [5, 0x102c06e0], [5, 0x102c9940], [5, 0x102d2ba0], [5, 0x102dbe00], [5, 0x102e5060], [5, 0x102ee2c0], [5, 0x102f7520], [5, 0x10300780], [5, 0x103099e0], [5, 0x10312c40], [5, 0x1031bea0], [5, 0x10325100], [5, 0x1032e360], [5, 0x103375c0], [5, 0x10340820], [5, 0x10349a80], [5, 0x10352ce0], [5, 0x1035bf40], [5, 0x103651a0], [5, 0x1036e400], [5, 0x10377660], [5, 0x103808c0], [5, 0x10389b20], [5, 0x10392d80], [5, 0x1039bfe0], [5, 0x103a5240], [5, 0x103ae4a0], [5, 0x103b7700], [5, 0x103c0960], [5, 0x103c9bc0], [5, 0x103d2e20], [5, 0x103dc080], [5, 0x103e52e0], [5, 0x103ee540], [5, 0x103f77a0], [5, 0x10400a00], [5, 0x10409c60], [5, 0x10412ec0], [5, 0x1041c120], [5, 0x10425380], [5, 0x1042e5e0], [5, 0x10437840], [5, 0x10440aa0]]

  output_dram:
    type: queue
    input: target_op0
    entries: 1
    grid_size: [10, 12]
    t: 3
    mblock: [8, 1]
    ublock: [1, 1]
    df: Float16
    ublock_order: r
    target_device: 0
    loc: dram
    dram: [[4, 0x10000000], [4, 0x1000c320], [4, 0x10018640], [4, 0x10024960], [4, 0x10030c80], [4, 0x1003cfa0], [4, 0x100492c0], [4, 0x100555e0], [4, 0x10061900], [4, 0x1006dc20], [4, 0x10079f40], [4, 0x10086260], [4, 0x10092580], [4, 0x1009e8a0], [4, 0x100aabc0], [4, 0x100b6ee0], [4, 0x100c3200], [4, 0x100cf520], [4, 0x100db840], [4, 0x100e7b60], [4, 0x100f3e80], [4, 0x101001a0], [4, 0x1010c4c0], [4, 0x101187e0], [4, 0x10124b00], [4, 0x10130e20], [4, 0x1013d140], [4, 0x10149460], [4, 0x10155780], [4, 0x10161aa0], [4, 0x1016ddc0], [4, 0x1017a0e0], [4, 0x10186400], [4, 0x10192720], [4, 0x1019ea40], [4, 0x101aad60], [4, 0x101b7080], [4, 0x101c33a0], [4, 0x101cf6c0], [4, 0x101db9e0], [4, 0x101e7d00], [4, 0x101f4020], [4, 0x10200340], [4, 0x1020c660], [4, 0x10218980], [4, 0x10224ca0], [4, 0x10230fc0], [4, 0x1023d2e0], [4, 0x10249600], [4, 0x10255920], [4, 0x10261c40], [4, 0x1026df60], [4, 0x1027a280], [4, 0x102865a0], [4, 0x102928c0], [4, 0x1029ebe0], [4, 0x102aaf00], [4, 0x102b7220], [4, 0x102c3540], [4, 0x102cf860], [4, 0x102dbb80], [4, 0x102e7ea0], [4, 0x102f41c0], [4, 0x103004e0], [4, 0x1030c800], [4, 0x10318b20], [4, 0x10324e40], [4, 0x10331160], [4, 0x1033d480], [4, 0x103497a0], [4, 0x10355ac0], [4, 0x10361de0], [4, 0x1036e100], [4, 0x1037a420], [4, 0x10386740], [4, 0x10392a60], [4, 0x1039ed80], [4, 0x103ab0a0], [4, 0x103b73c0], [4, 0x103c36e0], [4, 0x103cfa00], [4, 0x103dbd20], [4, 0x103e8040], [4, 0x103f4360], [4, 0x10400680], [4, 0x1040c9a0], [4, 0x10418cc0], [4, 0x10424fe0], [4, 0x10431300], [4, 0x1043d620], [4, 0x10449940], [4, 0x10455c60], [4, 0x10461f80], [4, 0x1046e2a0], [4, 0x1047a5c0], [4, 0x104868e0], [4, 0x10492c00], [4, 0x1049ef20], [4, 0x104ab240], [4, 0x104b7560], [4, 0x104c3880], [4, 0x104cfba0], [4, 0x104dbec0], [4, 0x104e81e0], [4, 0x104f4500], [4, 0x10500820], [4, 0x1050cb40], [4, 0x10518e60], [4, 0x10525180], [4, 0x105314a0], [4, 0x1053d7c0], [4, 0x10549ae0], [4, 0x10555e00], [4, 0x10562120], [4, 0x1056e440], [4, 0x1057a760], [4, 0x10586a80], [4, 0x10592da0], [4, 0x1059f0c0], [4, 0x105ab3e0]]

graphs:
  test_op:
    target_device: 0
    input_count: 1
    target_op0:
      type: matmul
      grid_loc: [0, 0]
      grid_size: [10, 12]
      inputs: [input0_dram, input1_dram]
      in_df: [Float16, Float16]
      acc_df: Float16
      out_df: Float16
      intermed_df: Float16
      ublock_order: r
      buf_size_mb: 1
      math_fidelity: HiFi4
      attributes: {m_k: 30, u_kt: 2}
      t: 3
      mblock: [8, 1]
      ublock: [1, 1]
      input_0_tms: [hslice: 1, vslice: 3]
      untilize_output: false

programs:
  - program0:
    - staticvar: [$lptr, $gptr]
    - var: [$c_microbatch_count, $c_zero, $c_wrap]
    - varinst: [$c_microbatch_count, set, 1]
    - varinst: [$c_zero, set, 0]
    - varinst: [$c_wrap, set, 2]
    - varinst: [$c_wrap, mul, $c_wrap, 1]  # c_wrap = 2*microbatch_size
    - varinst: [$c_wrap, mul, $c_wrap, 1] # c_wrap = 2*microbatch_size*microbatch_count
    - loop: $c_microbatch_count #loop over number of microbatches that make a minibatch
    -   execute: {
          graph_name: test_op,
          queue_settings: {
               input0_dram: {prologue: false, epilogue: false, zero: false, rd_ptr_local: $lptr, rd_ptr_global: $gptr},
               input1_dram: {prologue: false, epilogue: false, zero: false, rd_ptr_local: $lptr, rd_ptr_global: $gptr}
          }
        }
    -   varinst: [$lptr, incwrap, 1, $c_wrap]
    -   varinst: [$gptr, incwrap, 1, $c_wrap]
    - endloop

test-config:
  test-args:
    microbatch_count: 1 # entries / input_count
    microbatch_size: 1 # input_count
    minibatch_count: 1 # host loop iterations